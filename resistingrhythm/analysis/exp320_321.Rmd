---
title: "Analysis : exp320-21 g_KCa analysis"
output: html_notebook
---

# Header
```{r, message=FALSE}
library(ggplot2)
library(dplyr)
library(magrittr)
library(readr)
library(gridExtra)
library(grid)
library(ggpubr)
library(cowplot)

data_path <- "~/Code/resistingrhythm/data/"
```

# Load G_KCa
```{r, message=FALSE}
# ----------------------------------------------------------------------
# G_KCA perturb exps
# H
exp_code <- 321
osc_codes <- c(100, 115)
osc_rates <- c(0, 1.5)
stim_codes <- c(3, 4) # 4
g_KCas <- c("0.1e-3", "1e-3", "15e-3", "30e-3", "45e-3", "60e-3")

results321 <- NULL
for(i in 1:length(osc_codes)){
  for(s_c in stim_codes){
    for(g in g_KCas){
      
      o_c <- osc_codes[i]
      o_r <- osc_rates[i]
      
      # Load the csv
      # exp316_stim{1}_gl{3}_osc
      df <- read_csv(paste(data_path, 
                           "exp", as.character(exp_code), 
                           "_stim", as.character(s_c), 
                           "_GKCa", as.character(g), 
                           "_osc", as.character(o_c),
                           ".csv", sep=""))
      
      # Add metadata
      df$osc_code <- rep(o_c, nrow(df))
      df$osc_rate <- rep(o_r, nrow(df))
      df$stim_code <- rep(s_c, nrow(df))
      df$synapse <- rep("AMPA", nrow(df))
      df$g_L <- rep(g, nrow(df))
      df$homeo <- rep("Homeostasis", nrow(df))
      df$freq <- rep(8, nrow(df))
      
      results321 <- rbind(results321, df)
    }
  }
}
results321 %>%
  filter(rate_k > 0) -> results321

# no H
exp_code <- 320
osc_codes <- c(100, 115)
osc_rates <- c(0, 1.5)
stim_codes <- c(3, 4) # 4
g_KCas <- c("0.1e-3", "1e-3", "15e-3", "30e-3", "45e-3", "60e-3")

results320 <- NULL
for(i in 1:length(osc_codes)){
  for(s_c in stim_codes){
    for(g in g_KCas){
      
      o_c <- osc_codes[i]
      o_r <- osc_rates[i]
      
      # Load the csv
      # exp316_stim{1}_gl{3}_osc
      df <- read_csv(paste(data_path, 
                           "exp", as.character(exp_code), 
                           "_stim", as.character(s_c), 
                           "_GKCa", as.character(g), 
                           "_osc", as.character(o_c),
                           ".csv", sep=""))
      
      
      # Add metadata
      df$osc_code <- rep(o_c, nrow(df))
      df$osc_rate <- rep(o_r, nrow(df))
      df$stim_code <- rep(s_c, nrow(df))
      df$synapse <- rep("AMPA", nrow(df))
      df$g_L <- rep(g, nrow(df))
      df$homeo <- rep("No homeostasis", nrow(df))
      df$freq <- rep(8, nrow(df))
      
      results320 <- rbind(results320, df)
    }
  }
}
results320 %>%
  filter(rate_k > 0) -> results320

results <- rbind(
  results320,
  results321
)

results$g_L <- factor(results$g_L, levels=c("0.1e-3", "1e-3", "15e-3", "30e-3", "45e-3", "60e-3"))
```

# Plot
## Individual points
```{r, fig.height=1.2, fig.width=3.5}
results %>% 
  ggplot(aes(x=osc_rate, y=kappa_coord, group=interaction(osc_rate, homeo), color=g_L)) +
  geom_point(size=.5, alpha=0.6) +
  theme_classic() +
  scale_color_grey() +
  facet_grid(homeo~g_L, scales = "free")
```


```{r, fig.height=1.2, fig.width=3.5}
results %>% 
  ggplot(aes(x=osc_rate, y=rate_k, group=interaction(osc_rate, homeo), color=g_L)) +
  geom_point(size=.5, alpha=0.5) +
  theme_classic() +
  scale_color_viridis_d() + 
  facet_grid(homeo~., scales = "free")
```

## Means
```{r, fig.height=1.2, fig.width=1.2}
results %>% 
  filter(homeo=="Homeostasis") %>% 
  group_by(osc_rate, homeo, g_L) %>% 
  mutate(M=mean(kappa_coord), SD=sd(kappa_coord)) %>% 
  ggplot(aes(x=osc_rate, y=M, group=interaction(osc_rate, homeo), color=g_L)) +
  geom_linerange(mapping=aes(x=osc_rate, ymin=M - SD, ymax=M + SD, color=g_L), size=.4) +
  geom_point(size=.5, alpha=0.6) +
  theme_classic() +
  scale_color_viridis_d() +
  labs(tag="a.", y="Kappa", x="Osc. rate") +
  theme(plot.tag = element_text(size=16, face="bold"))
  # facet_grid(homeo~., scales = "free")
```


```{r, fig.height=1.2, fig.width=1.25}
results %>% 
  filter(homeo=="Homeostasis") %>% 
  group_by(osc_rate, homeo, g_L) %>% 
  mutate(M=mean(rate_k), SD=sd(rate_k)) %>% 
  ggplot(aes(x=osc_rate, y=M, group=interaction(osc_rate, homeo), color=g_L)) +
  geom_linerange(mapping=aes(x=osc_rate, ymin=M - SD, ymax=M + SD, color=g_L), size=.4) +
  geom_point(size=.5, alpha=0.6) +
  theme_classic() +
  scale_color_viridis_d() +
  labs(tag="b.", y="Pop. rate", x="Osc. rate") +
  theme(plot.tag = element_text(size=16, face="bold"))
  # facet_grid(homeo~., scales = "free")
```
